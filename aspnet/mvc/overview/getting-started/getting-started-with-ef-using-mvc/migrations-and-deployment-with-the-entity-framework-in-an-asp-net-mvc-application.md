---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: 'Tutorial: uso de migraciones de EF en una aplicación ASP.NET MVC e implementación en Azure'
author: tdykstra
description: En este tutorial, habilitará las migraciones de Code First e implementará la aplicación en la nube en Azure.
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 989dd0f0e18b338be057b9c5657586eff996d8ea
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/06/2020
ms.locfileid: "78499369"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a><span data-ttu-id="43282-103">Tutorial: uso de migraciones de EF en una aplicación ASP.NET MVC e implementación en Azure</span><span class="sxs-lookup"><span data-stu-id="43282-103">Tutorial: Use EF Migrations in an ASP.NET MVC app and deploy to Azure</span></span>

<span data-ttu-id="43282-104">Hasta ahora, la aplicación Web de ejemplo contoso University se ha ejecutado localmente en IIS Express en el equipo de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="43282-104">So far the Contoso University sample web application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="43282-105">Para que una aplicación real esté disponible para que otras personas puedan usarla a través de Internet, debe implementarla en un proveedor de hospedaje Web.</span><span class="sxs-lookup"><span data-stu-id="43282-105">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="43282-106">En este tutorial, habilitará las migraciones de Code First e implementará la aplicación en la nube en Azure:</span><span class="sxs-lookup"><span data-stu-id="43282-106">In this tutorial, you enable Code First migrations and deploy the application to the cloud in Azure:</span></span>

- <span data-ttu-id="43282-107">Habilitar Migraciones de Code First.</span><span class="sxs-lookup"><span data-stu-id="43282-107">Enable Code First Migrations.</span></span> <span data-ttu-id="43282-108">La característica migraciones permite cambiar el modelo de datos e implementar los cambios en producción actualizando el esquema de la base de datos sin tener que quitar y volver a crear la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-108">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="43282-109">Implemente en Azure.</span><span class="sxs-lookup"><span data-stu-id="43282-109">Deploy to Azure.</span></span> <span data-ttu-id="43282-110">Este paso es opcional; puede continuar con el resto de los tutoriales sin haber implementado el proyecto.</span><span class="sxs-lookup"><span data-stu-id="43282-110">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="43282-111">Se recomienda utilizar un proceso de integración continua con control de código fuente para la implementación, pero en este tutorial no se tratan los temas.</span><span class="sxs-lookup"><span data-stu-id="43282-111">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="43282-112">Para más información, consulte los capítulos sobre el [control de código fuente](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) y la [integración continua](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) de la [creación de aplicaciones en la nube reales con Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span><span class="sxs-lookup"><span data-stu-id="43282-112">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

<span data-ttu-id="43282-113">En este tutorial va a:</span><span class="sxs-lookup"><span data-stu-id="43282-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="43282-114">Habilitación de migraciones de Code First</span><span class="sxs-lookup"><span data-stu-id="43282-114">Enable Code First migrations</span></span>
> * <span data-ttu-id="43282-115">Implementación de la aplicación en Azure (opcional)</span><span class="sxs-lookup"><span data-stu-id="43282-115">Deploy the app in Azure (optional)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="43282-116">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="43282-116">Prerequisites</span></span>

- [<span data-ttu-id="43282-117">Resistencia de la conexión e intercepción de comandos</span><span class="sxs-lookup"><span data-stu-id="43282-117">Connection Resiliency and Command Interception</span></span>](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a><span data-ttu-id="43282-118">Habilitación de migraciones de Code First</span><span class="sxs-lookup"><span data-stu-id="43282-118">Enable Code First migrations</span></span>

<span data-ttu-id="43282-119">Al desarrollar una aplicación nueva, el modelo de datos cambia con frecuencia y, cada vez que lo hace, se deja de sincronizar con la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="43282-120">Ha configurado el Entity Framework para quitar y volver a crear la base de datos automáticamente cada vez que cambia el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="43282-121">Al agregar, quitar o cambiar las clases de entidad o cambiar la clase `DbContext`, la próxima vez que ejecute la aplicación, se eliminará automáticamente la base de datos existente, se creará una nueva que coincida con el modelo y se inicializará con los datos de prueba.</span><span class="sxs-lookup"><span data-stu-id="43282-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="43282-122">Este método para mantener la base de datos sincronizada con el modelo de datos funciona bien hasta que la aplicación se implemente en producción.</span><span class="sxs-lookup"><span data-stu-id="43282-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="43282-123">Cuando la aplicación se ejecuta en producción, normalmente almacena los datos que desea conservar y no desea perder todo cada vez que realice un cambio, como agregar una nueva columna.</span><span class="sxs-lookup"><span data-stu-id="43282-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="43282-124">La característica [migraciones de Code First](https://msdn.microsoft.com/data/jj591621) resuelve este problema habilitando Code First para actualizar el esquema de la base de datos en lugar de quitar y volver a crear la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="43282-125">En este tutorial, va a implementar la aplicación y a prepararse para habilitar las migraciones.</span><span class="sxs-lookup"><span data-stu-id="43282-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="43282-126">Deshabilite el inicializador que configuró anteriormente; para ello, agregue un comentario o elimine el elemento `contexts` que ha agregado al archivo Web. config de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="43282-127">También en el archivo *Web. config* de la aplicación, cambie el nombre de la base de datos en la cadena de conexión a ContosoUniversity2.</span><span class="sxs-lookup"><span data-stu-id="43282-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="43282-128">Este cambio configura el proyecto para que la primera migración cree una nueva base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="43282-129">Esto no es necesario, pero verá más adelante por qué es una buena idea.</span><span class="sxs-lookup"><span data-stu-id="43282-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="43282-130">En el menú **Herramientas**, seleccione **Administrador de paquetes NuGet** > **Consola del Administrador de paquetes**.</span><span class="sxs-lookup"><span data-stu-id="43282-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="43282-131">En el símbolo del sistema de `PM>`, escriba los siguientes comandos:</span><span class="sxs-lookup"><span data-stu-id="43282-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    <span data-ttu-id="43282-132">El comando `enable-migrations` crea una carpeta *Migrations* en el proyecto ContosoUniversity y coloca en esa carpeta un archivo *Configuration.CS* que se puede editar para configurar las migraciones.</span><span class="sxs-lookup"><span data-stu-id="43282-132">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="43282-133">(Si se perdió el paso anterior que le indica cambiar el nombre de la base de datos, las migraciones buscarán la base de datos existente y realizarán automáticamente el comando `add-migration`.</span><span class="sxs-lookup"><span data-stu-id="43282-133">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="43282-134">Esto es correcto, simplemente significa que no se ejecutará ninguna prueba del código de las migraciones antes de implementar la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-134">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="43282-135">Más adelante, cuando ejecute el comando `update-database` no ocurrirá nada porque la base de datos ya existe.</span><span class="sxs-lookup"><span data-stu-id="43282-135">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    <span data-ttu-id="43282-136">Abra el archivo *ContosoUniversity\Migrations\Configuration.CS* .</span><span class="sxs-lookup"><span data-stu-id="43282-136">Open the *ContosoUniversity\Migrations\Configuration.cs* file.</span></span> <span data-ttu-id="43282-137">Al igual que la clase de inicializador que vio anteriormente, la clase `Configuration` incluye un método `Seed`.</span><span class="sxs-lookup"><span data-stu-id="43282-137">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="43282-138">El propósito del método de [inicialización](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) es permitir la inserción o actualización de los datos de prueba después de Code First crea o actualiza la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-138">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="43282-139">Se llama al método cuando se crea la base de datos y cada vez que se actualiza el esquema de la base de datos después de un cambio en el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-139">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="43282-140">Configurar el método de inicialización</span><span class="sxs-lookup"><span data-stu-id="43282-140">Set up the Seed method</span></span>

<span data-ttu-id="43282-141">Cuando se quita y se vuelve a crear la base de datos para cada cambio de modelo de datos, se usa el método `Seed` de la clase de inicializador para insertar los datos de prueba, porque después de cada cambio de modelo se quita la base de datos y se pierden todos los datos de prueba.</span><span class="sxs-lookup"><span data-stu-id="43282-141">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="43282-142">Con Migraciones de Code First, los datos de prueba se conservan después de los cambios en la base de datos, por lo que normalmente no es necesario incluir datos de prueba en el método de [inicialización](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) .</span><span class="sxs-lookup"><span data-stu-id="43282-142">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="43282-143">De hecho, no desea que el método `Seed` Inserte los datos de prueba si va a usar las migraciones para implementar la base de datos en producción, ya que el método `Seed` se ejecutará en producción.</span><span class="sxs-lookup"><span data-stu-id="43282-143">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="43282-144">En ese caso, desea que el método `Seed` Inserte en la base de datos solo los datos que necesita en producción.</span><span class="sxs-lookup"><span data-stu-id="43282-144">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="43282-145">Por ejemplo, puede que desee que la base de datos incluya nombres de Departamento reales en la tabla `Department` cuando la aplicación esté disponible en producción.</span><span class="sxs-lookup"><span data-stu-id="43282-145">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="43282-146">En este tutorial, va a usar las migraciones para la implementación, pero el método de `Seed` insertará los datos de prueba para que sea más fácil ver cómo funciona la funcionalidad de la aplicación sin tener que insertar manualmente una gran cantidad de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-146">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="43282-147">Reemplace el contenido del archivo *Configuration.CS* por el código siguiente, que carga los datos de prueba en la nueva base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-147">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="43282-148">El método de [inicialización](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) toma el objeto de contexto de base de datos como parámetro de entrada y el código del método usa ese objeto para agregar nuevas entidades a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-148">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="43282-149">Para cada tipo de entidad, el código crea una colección de nuevas entidades, las agrega a la propiedad [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) adecuada y, a continuación, guarda los cambios en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-149">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="43282-150">No es necesario llamar al método [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) después de cada grupo de entidades, como se hace aquí, pero hacerlo le ayuda a localizar el origen de un problema si se produce una excepción mientras el código está escribiendo en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-150">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="43282-151">Algunas de las instrucciones que insertan datos usan el método [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) para realizar una operación "Upsert".</span><span class="sxs-lookup"><span data-stu-id="43282-151">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="43282-152">Dado que el método de `Seed` se ejecuta cada vez que se ejecuta el comando `update-database`, normalmente después de cada migración, no se pueden insertar datos, ya que las filas que está intentando agregar ya estarán allí después de la primera migración que crea la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-152">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="43282-153">La operación "Upsert" evita errores que podrían producirse si se intenta insertar una fila que ya existe, pero ***reemplaza*** cualquier cambio en los datos que haya realizado al probar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-153">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="43282-154">En el caso de los datos de prueba de algunas tablas, es posible que no desee que suceda: en algunos casos, cuando cambie los datos mientras realiza las pruebas desea que los cambios permanezcan después de las actualizaciones de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-154">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="43282-155">En ese caso, desea realizar una operación de inserción condicional: Inserte una fila solo si aún no existe.</span><span class="sxs-lookup"><span data-stu-id="43282-155">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="43282-156">El método de inicialización utiliza ambos enfoques.</span><span class="sxs-lookup"><span data-stu-id="43282-156">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="43282-157">El primer parámetro que se pasa al método [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) especifica la propiedad que se va a usar para comprobar si ya existe una fila.</span><span class="sxs-lookup"><span data-stu-id="43282-157">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="43282-158">En el caso de los datos de estudiante de prueba que se proporcionan, se puede usar la propiedad `LastName` para este propósito, ya que cada apellido de la lista es único:</span><span class="sxs-lookup"><span data-stu-id="43282-158">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="43282-159">Este código supone que los apellidos son únicos.</span><span class="sxs-lookup"><span data-stu-id="43282-159">This code assumes that last names are unique.</span></span> <span data-ttu-id="43282-160">Si agrega manualmente un estudiante con un apellido duplicado, recibirá la siguiente excepción la próxima vez que realice una migración:</span><span class="sxs-lookup"><span data-stu-id="43282-160">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="43282-161">**La secuencia contiene más de un elemento**</span><span class="sxs-lookup"><span data-stu-id="43282-161">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="43282-162">Para obtener información acerca de cómo administrar datos redundantes, como dos estudiantes denominados "Alexander Carson", consulte las bases de datos de [propagación y Depuración Entity Framework (EF)](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) en el blog de Rick Anderson.</span><span class="sxs-lookup"><span data-stu-id="43282-162">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="43282-163">Para obtener más información sobre el método `AddOrUpdate`, consulte el método de encargarse [con EF 4,3 AddOrUpdate](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) en el blog de Julia Lerman.</span><span class="sxs-lookup"><span data-stu-id="43282-163">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="43282-164">El código que crea entidades `Enrollment` supone que tiene el valor `ID` en las entidades de la colección `students`, aunque no estableció esa propiedad en el código que crea la colección.</span><span class="sxs-lookup"><span data-stu-id="43282-164">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="43282-165">Aquí puede usar la propiedad `ID` porque se establece el valor de `ID` cuando se llama a `SaveChanges` para la colección de `students`.</span><span class="sxs-lookup"><span data-stu-id="43282-165">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="43282-166">EF obtiene automáticamente el valor de la clave principal cuando inserta una entidad en la base de datos y actualiza la propiedad `ID` de la entidad en la memoria.</span><span class="sxs-lookup"><span data-stu-id="43282-166">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="43282-167">El código que agrega cada entidad `Enrollment` al conjunto de entidades `Enrollments` no usa el método `AddOrUpdate`.</span><span class="sxs-lookup"><span data-stu-id="43282-167">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="43282-168">Comprueba si ya existe una entidad e inserta la entidad si no existe.</span><span class="sxs-lookup"><span data-stu-id="43282-168">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="43282-169">Este enfoque conservará los cambios que realice en una calificación de inscripción mediante la interfaz de usuario de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-169">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="43282-170">El código recorre en bucle cada miembro de la [lista](https://msdn.microsoft.com/library/6sh2ey19.aspx) de `Enrollment`y, si no se encuentra la inscripción en la base de datos, agrega la inscripción a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-170">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="43282-171">La primera vez que actualice la base de datos, la base de datos estará vacía, por lo que agregará cada inscripción.</span><span class="sxs-lookup"><span data-stu-id="43282-171">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="43282-172">Compile el proyecto.</span><span class="sxs-lookup"><span data-stu-id="43282-172">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="43282-173">Ejecutar la primera migración</span><span class="sxs-lookup"><span data-stu-id="43282-173">Execute the first migration</span></span>

<span data-ttu-id="43282-174">Al ejecutar el comando `add-migration`, las migraciones generaron el código que crearía la base de datos desde cero.</span><span class="sxs-lookup"><span data-stu-id="43282-174">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="43282-175">Este código también se encuentra en la carpeta *Migrations* , en el archivo denominado *&lt;timestamp&gt;\_InitialCreate.CS*.</span><span class="sxs-lookup"><span data-stu-id="43282-175">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="43282-176">El método `Up` de la clase `InitialCreate` crea las tablas de base de datos que corresponden a los conjuntos de entidades del modelo de datos y el método `Down` las elimina.</span><span class="sxs-lookup"><span data-stu-id="43282-176">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="43282-177">Las migraciones llaman al método `Up` para implementar los cambios del modelo de datos para una migración.</span><span class="sxs-lookup"><span data-stu-id="43282-177">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="43282-178">Cuando se escribe un comando para revertir la actualización, las migraciones llaman al método `Down`.</span><span class="sxs-lookup"><span data-stu-id="43282-178">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="43282-179">Se trata de la migración inicial que se creó al escribir el comando `add-migration InitialCreate`.</span><span class="sxs-lookup"><span data-stu-id="43282-179">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="43282-180">El parámetro (`InitialCreate` en el ejemplo) se usa para el nombre de archivo y puede ser el que desee. Normalmente, se elige una palabra o frase que resume lo que se hace en la migración.</span><span class="sxs-lookup"><span data-stu-id="43282-180">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="43282-181">Por ejemplo, puede asignar un nombre a una migración posterior &quot;AddDepartmentTable&quot;.</span><span class="sxs-lookup"><span data-stu-id="43282-181">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="43282-182">Si creó la migración inicial cuando la base de datos ya existía, se genera el código de creación de la base de datos pero no es necesario ejecutarlo porque la base de datos ya coincide con el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-182">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="43282-183">Al implementar la aplicación en otro entorno donde la base de datos todavía no existe, se ejecutará este código para crear la base de datos, por lo que es recomendable probarlo primero.</span><span class="sxs-lookup"><span data-stu-id="43282-183">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="43282-184">Esta es la razón por la que cambió el nombre de la base de datos en la cadena de conexión anterior&mdash;para que las migraciones puedan crear una nueva desde cero.</span><span class="sxs-lookup"><span data-stu-id="43282-184">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="43282-185">En la ventana **Consola del Administrador de paquetas** , escriba el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="43282-185">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    <span data-ttu-id="43282-186">El comando `update-database` ejecuta el método `Up` para crear la base de datos y, a continuación, ejecuta el método `Seed` para rellenar la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-186">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="43282-187">El mismo proceso se ejecutará automáticamente en producción después de implementar la aplicación, como verá en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="43282-187">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="43282-188">Use **Explorador de servidores** para inspeccionar la base de datos como hizo en el primer tutorial y ejecute la aplicación para comprobar que todo funciona igual que antes.</span><span class="sxs-lookup"><span data-stu-id="43282-188">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="43282-189">Implementar en Azure</span><span class="sxs-lookup"><span data-stu-id="43282-189">Deploy to Azure</span></span>

<span data-ttu-id="43282-190">Hasta ahora, la aplicación se ejecuta localmente en IIS Express en el equipo de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="43282-190">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="43282-191">Para que esté disponible para que otras personas puedan utilizarla a través de Internet, debe implementarla en un proveedor de hospedaje Web.</span><span class="sxs-lookup"><span data-stu-id="43282-191">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="43282-192">En esta sección del tutorial, la implementará en Azure.</span><span class="sxs-lookup"><span data-stu-id="43282-192">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="43282-193">Esta sección es opcional. puede omitir esta opción y continuar con el siguiente tutorial, o puede adaptar las instrucciones de esta sección para un proveedor de hospedaje diferente de su elección.</span><span class="sxs-lookup"><span data-stu-id="43282-193">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="43282-194">Usar migraciones de Code First para implementar la base de datos</span><span class="sxs-lookup"><span data-stu-id="43282-194">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="43282-195">Para implementar la base de datos, usará Migraciones de Code First.</span><span class="sxs-lookup"><span data-stu-id="43282-195">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="43282-196">Al crear el perfil de publicación que se usa para configurar las opciones de implementación desde Visual Studio, se activará la casilla **Actualizar base de datos**.</span><span class="sxs-lookup"><span data-stu-id="43282-196">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="43282-197">Esta configuración hace que el proceso de implementación configure automáticamente el archivo *Web. config* de la aplicación en el servidor de destino para que Code First utilice la clase de inicializador `MigrateDatabaseToLatestVersion`.</span><span class="sxs-lookup"><span data-stu-id="43282-197">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="43282-198">Visual Studio no hace nada con la base de datos durante el proceso de implementación mientras está copiando el proyecto en el servidor de destino.</span><span class="sxs-lookup"><span data-stu-id="43282-198">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="43282-199">Cuando se ejecuta la aplicación implementada y se obtiene acceso a la base de datos por primera vez después de la implementación, Code First comprueba si la base de datos coincide con el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-199">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="43282-200">Si hay un error de coincidencia, Code First crea automáticamente la base de datos (si aún no existe) o actualiza el esquema de la base de datos a la versión más reciente (si existe una base de datos pero no coincide con el modelo).</span><span class="sxs-lookup"><span data-stu-id="43282-200">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="43282-201">Si la aplicación implementa un método de `Seed` migraciones, el método se ejecuta después de que se cree la base de datos o se actualice el esquema.</span><span class="sxs-lookup"><span data-stu-id="43282-201">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="43282-202">El método Migrations `Seed` inserta datos de prueba.</span><span class="sxs-lookup"><span data-stu-id="43282-202">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="43282-203">Si estuviera implementando en un entorno de producción, tendría que cambiar el método de `Seed` para que solo inserte los datos que desea insertar en la base de datos de producción.</span><span class="sxs-lookup"><span data-stu-id="43282-203">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="43282-204">Por ejemplo, en el modelo de datos actual podría querer tener cursos reales pero estudiantes ficticios en la base de datos de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="43282-204">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="43282-205">Puede escribir un método `Seed` para cargarlo tanto en el entorno de desarrollo como para, a continuación, comentar los estudiantes ficticios antes de realizar la implementación en producción.</span><span class="sxs-lookup"><span data-stu-id="43282-205">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="43282-206">O bien, puede escribir un método `Seed` para cargar solo los cursos, y especificar los estudiantes ficticios en la base de datos de prueba manualmente mediante la interfaz de usuario de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-206">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="43282-207">Obtener una cuenta de Azure</span><span class="sxs-lookup"><span data-stu-id="43282-207">Get an Azure account</span></span>

<span data-ttu-id="43282-208">Necesitará una cuenta de Azure.</span><span class="sxs-lookup"><span data-stu-id="43282-208">You'll need an Azure account.</span></span> <span data-ttu-id="43282-209">Si aún no tiene una, pero tiene una suscripción de Visual Studio, puede [activar las ventajas de la suscripción](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span><span class="sxs-lookup"><span data-stu-id="43282-209">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="43282-210">De lo contrario, puede crear una cuenta de evaluación gratuita en un par de minutos.</span><span class="sxs-lookup"><span data-stu-id="43282-210">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="43282-211">Para obtener más información, consulte [Evaluación gratuita de Azure](https://azure.microsoft.com/free/).</span><span class="sxs-lookup"><span data-stu-id="43282-211">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="43282-212">Creación de un sitio web y una base de datos SQL en Azure</span><span class="sxs-lookup"><span data-stu-id="43282-212">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="43282-213">La aplicación Web de Azure se ejecutará en un entorno de hospedaje compartido, lo que significa que se ejecuta en máquinas virtuales (VM) que se comparten con otros clientes de Azure.</span><span class="sxs-lookup"><span data-stu-id="43282-213">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="43282-214">Los entornos de hospedaje compartidos ofrecen un coste reducido a los nuevos usuarios de servicios en la nube.</span><span class="sxs-lookup"><span data-stu-id="43282-214">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="43282-215">Más adelante, si el tráfico web aumenta, es posible escalar la aplicación para atender la demanda ejecutándola en máquinas virtuales dedicadas.</span><span class="sxs-lookup"><span data-stu-id="43282-215">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="43282-216">Para obtener más información sobre las opciones de precios de Azure App Service, consulte [precios de App Service](https://azure.microsoft.com/pricing/details/app-service/).</span><span class="sxs-lookup"><span data-stu-id="43282-216">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="43282-217">Implementará la base de datos en Azure SQL Database.</span><span class="sxs-lookup"><span data-stu-id="43282-217">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="43282-218">SQL Database es un servicio de base de datos relacional basado en la nube que se basa en SQL Server Technologies.</span><span class="sxs-lookup"><span data-stu-id="43282-218">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="43282-219">Las herramientas y aplicaciones que funcionan con SQL Server también funcionan con SQL Database.</span><span class="sxs-lookup"><span data-stu-id="43282-219">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="43282-220">En el [portal de administración de Azure](https://portal.azure.com), elija **crear un recurso** en la pestaña de la izquierda y, a continuación, elija **ver todo** en el panel **nuevo** (o en la *hoja*) para ver todos los recursos disponibles.</span><span class="sxs-lookup"><span data-stu-id="43282-220">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="43282-221">Elija **aplicación web + SQL** en la sección **Web** de la hoja **todo** .</span><span class="sxs-lookup"><span data-stu-id="43282-221">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="43282-222">Por último, elija **crear**.</span><span class="sxs-lookup"><span data-stu-id="43282-222">Finally, choose **Create**.</span></span>

    ![Creación de un recurso en Azure Portal](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="43282-224">Se abre el formulario para crear un nuevo recurso de **aplicación web + SQL** .</span><span class="sxs-lookup"><span data-stu-id="43282-224">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="43282-225">Escriba una cadena en el cuadro Nombre de la **aplicación** para usarla como dirección URL única para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-225">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="43282-226">La dirección URL completa consistirá en lo que escriba aquí más el dominio predeterminado de App de Azure Services (. azurewebsites.net).</span><span class="sxs-lookup"><span data-stu-id="43282-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="43282-227">Si ya se ha tomado el nombre de la **aplicación** , el asistente le notificará con un mensaje de color rojo *el nombre de la aplicación no está disponible* .</span><span class="sxs-lookup"><span data-stu-id="43282-227">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="43282-228">Si el **nombre** de la aplicación está disponible, verá una marca de verificación verde.</span><span class="sxs-lookup"><span data-stu-id="43282-228">If the **App name** is available, you see a green checkmark.</span></span>

3. <span data-ttu-id="43282-229">En el cuadro **suscripción** , elija la suscripción de Azure en la que desea que resida el **App Service** .</span><span class="sxs-lookup"><span data-stu-id="43282-229">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="43282-230">En el cuadro de texto **grupo de recursos** , elija un grupo de recursos o cree uno nuevo.</span><span class="sxs-lookup"><span data-stu-id="43282-230">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="43282-231">Esta configuración especifica en qué centro de datos se ejecutará el sitio Web.</span><span class="sxs-lookup"><span data-stu-id="43282-231">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="43282-232">Para obtener más información sobre los grupos de recursos, consulte [grupos de recursos](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span><span class="sxs-lookup"><span data-stu-id="43282-232">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="43282-233">Cree un **plan de App Service** nuevo haciendo clic en la *sección App Service*, **cree un nuevo**y rellene **App Service Plan** (puede tener el mismo nombre que App Service), la **Ubicación**y el plan de **tarifa** (hay una opción gratuita).</span><span class="sxs-lookup"><span data-stu-id="43282-233">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="43282-234">Haga clic en **SQL Database**y, a continuación, elija **crear una nueva base de datos** o seleccionar una base de datos existente.</span><span class="sxs-lookup"><span data-stu-id="43282-234">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

7. <span data-ttu-id="43282-235">En el cuadro **nombre** , escriba un nombre para la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-235">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="43282-236">Haga clic en el cuadro **servidor de destino** y, a continuación, seleccione **crear un nuevo servidor**.</span><span class="sxs-lookup"><span data-stu-id="43282-236">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="43282-237">Como alternativa, si creó anteriormente un servidor, puede seleccionar ese servidor en la lista de servidores disponibles.</span><span class="sxs-lookup"><span data-stu-id="43282-237">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="43282-238">Elija la sección **plan de tarifa** , seleccione *gratis*.</span><span class="sxs-lookup"><span data-stu-id="43282-238">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="43282-239">Si se necesitan recursos adicionales, la base de datos se puede escalar verticalmente en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="43282-239">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="43282-240">Para obtener más información sobre los precios de Azure SQL, consulte [precios de Azure SQL Database](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="43282-240">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="43282-241">Modifique la [Intercalación](/sql/relational-databases/collations/collation-and-unicode-support) según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="43282-241">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="43282-242">Escriba un **nombre de usuario** administrador de SQL y una contraseña de administrador de **SQL**.</span><span class="sxs-lookup"><span data-stu-id="43282-242">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

    - <span data-ttu-id="43282-243">Si seleccionó **nuevo servidor de SQL Database**, defina un nuevo nombre y contraseña que usará más adelante cuando tenga acceso a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-243">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
    - <span data-ttu-id="43282-244">Si ha seleccionado un servidor que ha creado anteriormente, escriba las credenciales para ese servidor.</span><span class="sxs-lookup"><span data-stu-id="43282-244">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="43282-245">La colección de telemetría se puede habilitar para App Service mediante Application Insights.</span><span class="sxs-lookup"><span data-stu-id="43282-245">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="43282-246">Con poca configuración, Application Insights recopila información valiosa sobre eventos, excepciones, dependencias, solicitudes y seguimientos.</span><span class="sxs-lookup"><span data-stu-id="43282-246">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="43282-247">Para obtener más información acerca de Application Insights, vea [Azure monitor](https://azure.microsoft.com/services/monitor/).</span><span class="sxs-lookup"><span data-stu-id="43282-247">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="43282-248">Haga clic en **crear** en la parte inferior para indicar que ha terminado.</span><span class="sxs-lookup"><span data-stu-id="43282-248">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="43282-249">El Portal de administración vuelve a la página panel y el área **notificaciones** en la parte superior de la página muestra que se está creando el sitio.</span><span class="sxs-lookup"><span data-stu-id="43282-249">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="43282-250">Después de un tiempo (normalmente menos de un minuto), hay una notificación de que la implementación se realizó correctamente.</span><span class="sxs-lookup"><span data-stu-id="43282-250">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="43282-251">En la barra de navegación de la izquierda, el nuevo App Service aparece en la sección **App Services** y la nueva base de datos SQL aparece en la sección bases de datos **SQL** .</span><span class="sxs-lookup"><span data-stu-id="43282-251">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="43282-252">Implementación de la aplicación en Azure</span><span class="sxs-lookup"><span data-stu-id="43282-252">Deploy the app to Azure</span></span>

1. <span data-ttu-id="43282-253">En Visual Studio, haga clic con el botón derecho en el proyecto, en el **Explorador de soluciones** y seleccione **Publicar** en el menú contextual.</span><span class="sxs-lookup"><span data-stu-id="43282-253">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

2. <span data-ttu-id="43282-254">En la página **seleccionar un destino de publicación** , elija **App Service** y, a continuación, **Seleccione existente**y, a continuación, elija **publicar**.</span><span class="sxs-lookup"><span data-stu-id="43282-254">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![Seleccionar una página de destino de publicación](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="43282-256">Si no ha agregado previamente su suscripción de Azure en Visual Studio, siga los pasos de la pantalla.</span><span class="sxs-lookup"><span data-stu-id="43282-256">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="43282-257">Estos pasos permiten que Visual Studio se conecte a su suscripción de Azure para que la lista de **App Services** incluya el sitio Web.</span><span class="sxs-lookup"><span data-stu-id="43282-257">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="43282-258">En la página **App Service** , seleccione la **suscripción** a la que ha agregado el App Service.</span><span class="sxs-lookup"><span data-stu-id="43282-258">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="43282-259">En **Ver**, seleccione **grupo de recursos**.</span><span class="sxs-lookup"><span data-stu-id="43282-259">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="43282-260">Expanda el grupo de recursos al que agregó el App Service y, a continuación, seleccione el App Service.</span><span class="sxs-lookup"><span data-stu-id="43282-260">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="43282-261">Elija **Aceptar** para publicar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43282-261">Choose **OK** to publish the app.</span></span>

5. <span data-ttu-id="43282-262">La ventana **Salida** muestra qué acciones de implementación se realizaron e informa de la correcta finalización de la implementación.</span><span class="sxs-lookup"><span data-stu-id="43282-262">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

6. <span data-ttu-id="43282-263">Tras una implementación correcta, el explorador predeterminado se abre automáticamente en la dirección URL del sitio Web implementado.</span><span class="sxs-lookup"><span data-stu-id="43282-263">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="43282-265">La aplicación se ejecuta ahora en la nube.</span><span class="sxs-lookup"><span data-stu-id="43282-265">Your app is now running in the cloud.</span></span>

<span data-ttu-id="43282-266">En este momento, la base de datos *SchoolContext* se ha creado en la base de datos SQL de Azure porque seleccionó **Ejecutar migraciones de Code First (se ejecuta al iniciar la aplicación)** .</span><span class="sxs-lookup"><span data-stu-id="43282-266">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="43282-267">El archivo *Web. config* del sitio Web implementado se ha cambiado para que el inicializador [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) se ejecute la primera vez que el código lea o escriba datos en la base de datos (que se produjo al seleccionar la pestaña **Students** ):</span><span class="sxs-lookup"><span data-stu-id="43282-267">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Extracto del archivo Web. config](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="43282-269">El proceso de implementación también ha creado una nueva cadena de conexión *(SchoolContext\_DatabasePublish*) para que migraciones de Code First la pueda usar para actualizar el esquema de la base de datos y para inicializar la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-269">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Cadena de conexión en el archivo Web. config](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="43282-271">Puede encontrar la versión implementada del archivo Web. config en su propio equipo en *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. Puede tener acceso al propio archivo *Web. config* implementado mediante FTP.</span><span class="sxs-lookup"><span data-stu-id="43282-271">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="43282-272">Para obtener instrucciones, consulte [ASP.net web Deployment Using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span><span class="sxs-lookup"><span data-stu-id="43282-272">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="43282-273">Siga las instrucciones que comienzan con "para usar una herramienta de FTP, necesita tres cosas: la dirección URL de FTP, el nombre de usuario y la contraseña".</span><span class="sxs-lookup"><span data-stu-id="43282-273">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="43282-274">La aplicación web no implementa la seguridad, por lo que cualquiera que encuentre la dirección URL puede cambiar los datos.</span><span class="sxs-lookup"><span data-stu-id="43282-274">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="43282-275">Para obtener instrucciones sobre cómo proteger el sitio web, vea [implementación de una aplicación ASP.NET MVC segura con suscripción, OAuth y SQL Database en Azure](/aspnet/core/security/authorization/secure-data).</span><span class="sxs-lookup"><span data-stu-id="43282-275">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="43282-276">Puede impedir que otras personas usen el sitio al detener el servicio con Azure Portal de administración o **Explorador de servidores** en Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="43282-276">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![Detener elemento de menú de App Service](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="43282-278">Escenarios de migraciones avanzadas</span><span class="sxs-lookup"><span data-stu-id="43282-278">Advanced migrations scenarios</span></span>

<span data-ttu-id="43282-279">Si implementa una base de datos mediante la ejecución de migraciones automáticamente, tal y como se muestra en este tutorial, y está implementando en un sitio web que se ejecuta en varios servidores, puede obtener varios servidores que intenten ejecutar migraciones al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="43282-279">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="43282-280">Las migraciones son atómicas, por lo que si dos servidores intentan ejecutar la misma migración, una se realizará correctamente y la otra producirá un error (suponiendo que las operaciones no se pueden realizar dos veces).</span><span class="sxs-lookup"><span data-stu-id="43282-280">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="43282-281">En ese escenario, si desea evitar estos problemas, puede llamar a las migraciones manualmente y configurar su propio código para que solo se produzca una vez.</span><span class="sxs-lookup"><span data-stu-id="43282-281">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="43282-282">Para obtener más información, consulte [ejecución y scripting de migraciones desde código](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) en el blog de Rowan Miller y [Migrate. exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (para ejecutar migraciones desde la línea de comandos).</span><span class="sxs-lookup"><span data-stu-id="43282-282">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="43282-283">Para obtener información sobre otros escenarios de migración, consulte la [serie de presentaciones](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx)en pantalla de migraciones.</span><span class="sxs-lookup"><span data-stu-id="43282-283">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="update-specific-migration"></a><span data-ttu-id="43282-284">Actualización de la migración específica</span><span class="sxs-lookup"><span data-stu-id="43282-284">Update specific migration</span></span>

`update-database -target MigrationName`

<span data-ttu-id="43282-285">El comando `update-database -target MigrationName` ejecuta la migración de destino.</span><span class="sxs-lookup"><span data-stu-id="43282-285">The `update-database -target MigrationName` command runs the targeted migration.</span></span>

## <a name="ignore-migration-changes-to-database"></a><span data-ttu-id="43282-286">Omitir cambios de migración en la base de datos</span><span class="sxs-lookup"><span data-stu-id="43282-286">Ignore migration changes to database</span></span>

`Add-migration MigrationName -ignoreChanges`

<span data-ttu-id="43282-287">`ignoreChanges` crea una migración vacía con el modelo actual como una instantánea.</span><span class="sxs-lookup"><span data-stu-id="43282-287">`ignoreChanges` creates an empty migration with the current model as a snapshot.</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="43282-288">Inicializadores de Code First</span><span class="sxs-lookup"><span data-stu-id="43282-288">Code First initializers</span></span>

<span data-ttu-id="43282-289">En la sección implementación, vio el inicializador [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) que se usaba.</span><span class="sxs-lookup"><span data-stu-id="43282-289">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="43282-290">Code First también proporciona otros inicializadores, como [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (el valor predeterminado), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (que usó anteriormente) y [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span><span class="sxs-lookup"><span data-stu-id="43282-290">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="43282-291">El inicializador de `DropCreateAlways` puede ser útil para configurar las condiciones de las pruebas unitarias.</span><span class="sxs-lookup"><span data-stu-id="43282-291">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="43282-292">También puede escribir sus propios inicializadores, y puede llamar a un inicializador explícitamente si no desea esperar hasta que la aplicación lea o escriba en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="43282-292">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="43282-293">Para obtener más información sobre los inicializadores, vea [Descripción de los inicializadores de base de datos en Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) y el capítulo 6 del libro [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julia Lerman y Rowan Miller.</span><span class="sxs-lookup"><span data-stu-id="43282-293">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="get-the-code"></a><span data-ttu-id="43282-294">Obtención del código</span><span class="sxs-lookup"><span data-stu-id="43282-294">Get the code</span></span>

[<span data-ttu-id="43282-295">Descargar el proyecto completado</span><span class="sxs-lookup"><span data-stu-id="43282-295">Download the Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="43282-296">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="43282-296">Additional resources</span></span>

<span data-ttu-id="43282-297">Los vínculos a otros recursos de Entity Framework pueden encontrarse en [el acceso a datos ASP.net: recursos recomendados](xref:whitepapers/aspnet-data-access-content-map).</span><span class="sxs-lookup"><span data-stu-id="43282-297">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

## <a name="next-steps"></a><span data-ttu-id="43282-298">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="43282-298">Next steps</span></span>

<span data-ttu-id="43282-299">En este tutorial va a:</span><span class="sxs-lookup"><span data-stu-id="43282-299">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="43282-300">Migraciones de Code First habilitadas</span><span class="sxs-lookup"><span data-stu-id="43282-300">Enabled Code First migrations</span></span>
> * <span data-ttu-id="43282-301">Implementación de la aplicación en Azure (opcional)</span><span class="sxs-lookup"><span data-stu-id="43282-301">Deployed the app in Azure (optional)</span></span>

<span data-ttu-id="43282-302">Avance al siguiente artículo para aprender a crear un modelo de datos más complejo para una aplicación ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="43282-302">Advance to the next article to learn how to create a more complex data model for an ASP.NET MVC Application.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="43282-303">Crear un modelo de datos más complejo</span><span class="sxs-lookup"><span data-stu-id="43282-303">Create a more complex data model</span></span>](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
